# è®¤è¯ç³»ç»Ÿè®¾ç½®æŒ‡å—

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. æ ¸å¿ƒæ–‡ä»¶

| æ–‡ä»¶ | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| AuthManager.swift | `/Managers/AuthManager.swift` | è®¤è¯ç®¡ç†å™¨ï¼ˆæ ¸å¿ƒé€»è¾‘ï¼‰ |
| SupabaseService.swift | `/Services/SupabaseService.swift` | Supabase å®¢æˆ·ç«¯é…ç½® |
| AuthView.swift | `/Views/Auth/AuthView.swift` | è®¤è¯ç•Œé¢ï¼ˆç™»å½•/æ³¨å†Œ/æ‰¾å›å¯†ç ï¼‰ |
| RootView.swift | `/Views/RootView.swift` | æ ¹è§†å›¾ï¼ˆè·¯ç”±æ§åˆ¶ï¼‰âœ… å·²æ›´æ–° |
| ProfileTabView.swift | `/Views/Tabs/ProfileTabView.swift` | ä¸ªäººé¡µé¢ âœ… å·²æ·»åŠ ç™»å‡ºåŠŸèƒ½ |

### 2. è®¤è¯æµç¨‹

#### æ³¨å†Œæµç¨‹ï¼ˆ3æ­¥ï¼‰
1. **è¾“å…¥é‚®ç®±** â†’ å‘é€éªŒè¯ç 
2. **éªŒè¯ç éªŒè¯** â†’ ç”¨æˆ·å·²ç™»å½•ï¼ˆä½† isAuthenticated=falseï¼‰
3. **è®¾ç½®å¯†ç ** â†’ isAuthenticated=true â†’ è¿›å…¥ä¸»é¡µ

#### ç™»å½•æµç¨‹ï¼ˆ1æ­¥ï¼‰
- **é‚®ç®± + å¯†ç ** â†’ ç›´æ¥ç™»å½• â†’ è¿›å…¥ä¸»é¡µ

#### æ‰¾å›å¯†ç æµç¨‹ï¼ˆ3æ­¥ï¼‰
1. **è¾“å…¥é‚®ç®±** â†’ å‘é€é‡ç½®éªŒè¯ç 
2. **éªŒè¯é‡ç½®ç ** â†’ éªŒè¯æˆåŠŸï¼ˆtype: .recoveryï¼‰
3. **è®¾ç½®æ–°å¯†ç ** â†’ å®Œæˆé‡ç½® â†’ è¿›å…¥ä¸»é¡µ

### 3. ç•Œé¢åŠŸèƒ½

#### AuthView åŒ…å«ï¼š
- âœ… æ·±è‰²æ¸å˜èƒŒæ™¯
- âœ… Logo + "åœ°çƒæ–°ä¸»"æ ‡é¢˜
- âœ… Tab åˆ‡æ¢ï¼ˆç™»å½•/æ³¨å†Œï¼‰
- âœ… ç™»å½•è¡¨å•ï¼ˆé‚®ç®±ã€å¯†ç ã€å¿˜è®°å¯†ç é“¾æ¥ï¼‰
- âœ… æ³¨å†Œä¸‰æ­¥æµç¨‹ï¼ˆå¸¦60ç§’å€’è®¡æ—¶ï¼‰
- âœ… å¿˜è®°å¯†ç å¼¹çª—ï¼ˆSheetï¼‰
- âœ… ç¬¬ä¸‰æ–¹ç™»å½•å ä½ï¼ˆApple/Google - æ˜¾ç¤º"å³å°†å¼€æ”¾"ï¼‰
- âœ… é”™è¯¯æç¤ºï¼ˆçº¢è‰²ï¼‰
- âœ… åŠ è½½æŒ‡ç¤ºå™¨

#### çŠ¶æ€ç®¡ç†ï¼š
- âœ… æ ¹æ® `authManager.otpSent` æ§åˆ¶æ˜¯å¦æ˜¾ç¤ºéªŒè¯ç è¾“å…¥
- âœ… æ ¹æ® `authManager.otpVerified` æ§åˆ¶æ˜¯å¦æ˜¾ç¤ºå¯†ç è®¾ç½®
- âœ… æ ¹æ® `authManager.needsPasswordSetup` å¼ºåˆ¶è®¾ç½®å¯†ç 
- âœ… æ ¹æ® `authManager.isAuthenticated` æ§åˆ¶æ˜¯å¦è¿›å…¥ä¸»é¡µ

## âš ï¸ é‡è¦æ³¨æ„äº‹é¡¹

### 1. Supabase é‚®ä»¶æ¨¡æ¿é…ç½®

åœ¨ä½¿ç”¨å‰ï¼Œéœ€è¦åœ¨ Supabase Dashboard ä¸­é…ç½®é‚®ä»¶æ¨¡æ¿ï¼š

**è·¯å¾„**: Supabase Dashboard â†’ Authentication â†’ Email Templates

#### å¿…éœ€æ¨¡æ¿ï¼š
1. **Magic Link** - ç”¨äºæ³¨å†Œ OTP
   - å‘é€ 6 ä½éªŒè¯ç 
   - æœ‰æ•ˆæœŸå»ºè®® 10 åˆ†é’Ÿ

2. **Reset Password** - ç”¨äºå¯†ç é‡ç½® OTP
   - å‘é€ 6 ä½éªŒè¯ç 
   - æœ‰æ•ˆæœŸå»ºè®® 10 åˆ†é’Ÿ

### 2. OTP éªŒè¯ç±»å‹

**å…³é”®åŒºåˆ«**ï¼š
```swift
// æ³¨å†Œæµç¨‹
.verifyOTP(email: email, token: code, type: .email)

// æ‰¾å›å¯†ç æµç¨‹
.verifyOTP(email: email, token: code, type: .recovery)  // æ³¨æ„è¿™é‡Œæ˜¯ .recovery
```

### 3. æ³¨å†Œæµç¨‹çš„å®‰å…¨é€»è¾‘

éªŒè¯ OTP æˆåŠŸåï¼š
- âœ… ç”¨æˆ·å·²ç™»å½•åˆ° Supabase
- âŒ `isAuthenticated` ä»ä¸º `false`
- âœ… `needsPasswordSetup` ä¸º `true`

**ç›®çš„**ï¼šå¼ºåˆ¶ç”¨æˆ·è®¾ç½®å¯†ç ï¼Œé˜²æ­¢åªé€šè¿‡ OTP å°±èƒ½è®¿é—®åº”ç”¨

## ğŸš€ ä¸‹ä¸€æ­¥æ“ä½œ

### 1. æµ‹è¯•è®¤è¯æµç¨‹

åœ¨æ¨¡æ‹Ÿå™¨ä¸­æµ‹è¯•ï¼š
1. å¯åŠ¨åº”ç”¨ â†’ çœ‹åˆ°å¯åŠ¨é¡µ â†’ è¿›å…¥è®¤è¯é¡µ
2. ç‚¹å‡»"æ³¨å†Œ" Tab
3. è¾“å…¥é‚®ç®±ï¼ˆçœŸå®é‚®ç®±ï¼Œå¯ä»¥æ”¶åˆ°éªŒè¯ç ï¼‰
4. å‘é€éªŒè¯ç  â†’ æ£€æŸ¥é‚®ä»¶
5. è¾“å…¥éªŒè¯ç  â†’ éªŒè¯æˆåŠŸ
6. è®¾ç½®å¯†ç  â†’ å®Œæˆæ³¨å†Œ â†’ è¿›å…¥ä¸»é¡µ
7. åœ¨"ä¸ªäºº"é¡µé¢ç‚¹å‡»"ç™»å‡º"
8. ä½¿ç”¨é‚®ç®±å’Œå¯†ç ç™»å½•

### 2. Supabase é‚®ä»¶é…ç½®ï¼ˆå¿…éœ€ï¼‰

#### æ–¹æ³• 1ï¼šä½¿ç”¨ Supabase é»˜è®¤é‚®ä»¶æœåŠ¡
- å¼€ç®±å³ç”¨ï¼Œä½†æœ‰å‘é€é™åˆ¶

#### æ–¹æ³• 2ï¼šé…ç½®è‡ªå®šä¹‰ SMTPï¼ˆæ¨èç”Ÿäº§ç¯å¢ƒï¼‰
- Dashboard â†’ Project Settings â†’ Auth â†’ SMTP Settings
- æ”¯æŒ SendGridã€Mailgunã€AWS SES ç­‰

### 3. å¯†ç å¼ºåº¦éªŒè¯ï¼ˆå»ºè®®æ·»åŠ ï¼‰

åœ¨ `AuthView.swift` ä¸­æ·»åŠ å¯†ç éªŒè¯ï¼š
```swift
private var isPasswordValid: Bool {
    let hasMinLength = registerPassword.count >= 6
    let hasNumber = registerPassword.range(of: #"\d"#, options: .regularExpression) != nil
    let hasLetter = registerPassword.range(of: #"[a-zA-Z]"#, options: .regularExpression) != nil

    return hasMinLength && hasNumber && hasLetter &&
           registerPassword == registerConfirmPassword
}
```

## ğŸ“‹ æ–‡ä»¶æ¸…å•

### å·²åˆ›å»º/æ›´æ–°çš„æ–‡ä»¶ï¼š
```
EarthLord/
â”œâ”€â”€ Managers/
â”‚   â””â”€â”€ AuthManager.swift                 âœ… æ–°å»º
â”œâ”€â”€ Services/
â”‚   â””â”€â”€ SupabaseService.swift             âœ… æ–°å»º
â”œâ”€â”€ Views/
â”‚   â”œâ”€â”€ Auth/
â”‚   â”‚   â””â”€â”€ AuthView.swift                âœ… æ–°å»º
â”‚   â”œâ”€â”€ RootView.swift                    âœ… æ›´æ–°
â”‚   â””â”€â”€ Tabs/
â”‚       â””â”€â”€ ProfileTabView.swift          âœ… æ›´æ–°
â””â”€â”€ AUTHENTICATION_GUIDE.md               âœ… ä½¿ç”¨æŒ‡å—
```

## ğŸ” å®‰å…¨å»ºè®®

1. âœ… ä½¿ç”¨ HTTPSï¼ˆSupabase é»˜è®¤ï¼‰
2. âœ… Publishable Key å¯ä»¥æ”¾åœ¨å®¢æˆ·ç«¯
3. âŒ **æ°¸è¿œä¸è¦**åœ¨å®¢æˆ·ç«¯å­˜å‚¨ Service Role Key
4. âœ… æ‰€æœ‰æ•°æ®æ“ä½œé€šè¿‡ RLS ä¿æŠ¤
5. âš ï¸ è€ƒè™‘æ·»åŠ å¯†ç å¼ºåº¦è¦æ±‚
6. âš ï¸ è€ƒè™‘æ·»åŠ é‚®ç®±æ ¼å¼éªŒè¯
7. âš ï¸ è€ƒè™‘æ·»åŠ éªŒè¯ç é”™è¯¯æ¬¡æ•°é™åˆ¶

## ğŸ¨ UI å®šåˆ¶

### é¢œè‰²ä¸»é¢˜
ä½¿ç”¨ `ApocalypseTheme`ï¼ˆå·²åœ¨é¡¹ç›®ä¸­å®šä¹‰ï¼‰ï¼š
- `primary` - ä¸»è‰²è°ƒï¼ˆæ©™è‰²ï¼‰
- `textPrimary` - ä¸»æ–‡å­—é¢œè‰²
- `textSecondary` - æ¬¡è¦æ–‡å­—é¢œè‰²

### è‡ªå®šä¹‰ç»„ä»¶
- `CustomTextField` - è‡ªå®šä¹‰æ–‡æœ¬è¾“å…¥æ¡†
- `CustomSecureField` - è‡ªå®šä¹‰å¯†ç è¾“å…¥æ¡†

## ğŸ“± ç”¨æˆ·ä½“éªŒä¼˜åŒ–å»ºè®®

1. âœ… 60ç§’å€’è®¡æ—¶ï¼ˆé˜²æ­¢é¢‘ç¹å‘é€éªŒè¯ç ï¼‰
2. âœ… åŠ è½½æŒ‡ç¤ºå™¨ï¼ˆå¼‚æ­¥æ“ä½œåé¦ˆï¼‰
3. âœ… é”™è¯¯æç¤ºï¼ˆçº¢è‰²èƒŒæ™¯ï¼‰
4. âš ï¸ å»ºè®®æ·»åŠ ï¼šæˆåŠŸæç¤ºï¼ˆç»¿è‰²èƒŒæ™¯ï¼‰
5. âš ï¸ å»ºè®®æ·»åŠ ï¼šé”®ç›˜è‡ªåŠ¨å…³é—­
6. âš ï¸ å»ºè®®æ·»åŠ ï¼šè¾“å…¥æ¡†ç„¦ç‚¹ç®¡ç†

## ğŸ› å¸¸è§é—®é¢˜

### Q: æ”¶ä¸åˆ°éªŒè¯ç é‚®ä»¶ï¼Ÿ
A:
1. æ£€æŸ¥ Supabase Email Templates æ˜¯å¦é…ç½®
2. æ£€æŸ¥é‚®ç®±æ˜¯å¦åœ¨åƒåœ¾é‚®ä»¶ä¸­
3. æ£€æŸ¥ Supabase Auth Settings ä¸­æ˜¯å¦å¯ç”¨äº† Email OTP

### Q: éªŒè¯ç éªŒè¯å¤±è´¥ï¼Ÿ
A:
1. ç¡®è®¤éªŒè¯ç æœªè¿‡æœŸï¼ˆé»˜è®¤10åˆ†é’Ÿï¼‰
2. ç¡®è®¤ä½¿ç”¨äº†æ­£ç¡®çš„ typeï¼ˆæ³¨å†Œç”¨ .emailï¼Œé‡ç½®ç”¨ .recoveryï¼‰
3. æ£€æŸ¥ Supabase Dashboard â†’ Authentication â†’ Logs

### Q: ç™»å½•åç«‹å³é€€å‡ºï¼Ÿ
A:
- æ£€æŸ¥ `checkSession()` é€»è¾‘
- æŸ¥çœ‹ Supabase Dashboard çš„ Auth Logs

## ğŸ“Š ä¸‹ä¸€æ­¥å¼€å‘å»ºè®®

1. **Profile åˆ›å»º**
   - ç”¨æˆ·æ³¨å†ŒæˆåŠŸåè‡ªåŠ¨åˆ›å»º profiles è¡¨è®°å½•
   - åœ¨ `completeRegistration()` åè°ƒç”¨

2. **ç”¨æˆ·åè®¾ç½®**
   - åœ¨å¯†ç è®¾ç½®æ­¥éª¤åæ·»åŠ ç”¨æˆ·åè¾“å…¥
   - æ›´æ–° profiles è¡¨

3. **å¤´åƒä¸Šä¼ **
   - é›†æˆ Supabase Storage
   - åœ¨ä¸ªäººé¡µé¢æ·»åŠ å¤´åƒä¸Šä¼ åŠŸèƒ½

4. **ç¬¬ä¸‰æ–¹ç™»å½•**
   - å®ç° Sign in with Apple
   - å®ç° Sign in with Google
   - é…ç½® Supabase OAuth

5. **ç”Ÿç‰©è¯†åˆ«ç™»å½•**
   - Face ID / Touch ID
   - å­˜å‚¨å‡­è¯åˆ° Keychain
