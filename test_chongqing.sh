#!/bin/bash

# 自动化圈地测试脚本（基于重庆位置）
# 起点：29.64, 106.56

echo "🚀 开始自动化圈地测试（重庆区域）..."
echo ""
echo "⚠️  准备工作："
echo "   1. 确保模拟器正在运行 EarthLord App"
echo "   2. 点击「停止圈地」按钮（如果正在追踪）"
echo "   3. 等待 3 秒"
echo ""
read -p "准备好了吗？按回车键继续..."

# 获取模拟器 ID
SIMULATOR_ID=$(xcrun simctl list devices | grep "Booted" | grep -oE '[A-F0-9-]{36}' | head -1)

if [ -z "$SIMULATOR_ID" ]; then
    echo "❌ 错误：找不到正在运行的模拟器"
    exit 1
fi

echo "✅ 找到模拟器: $SIMULATOR_ID"
echo ""

# 先停止圈地，清除之前的状态
echo "📍 重置位置..."
xcrun simctl location "$SIMULATOR_ID" clear
sleep 1

# 定义轨迹点（基于重庆坐标：29.64, 106.56，正方形，边长约 40 米）
# 1 度纬度 ≈ 111 km，1 度经度 ≈ 96 km（重庆纬度）
# 15 米 ≈ 0.00014 度纬度，≈ 0.00016 度经度

POINTS=(
    "29.64000,106.56000"      # 起点（西南角）
    "29.64014,106.56000"      # 向北（约15米）
    "29.64028,106.56000"      # 向北
    "29.64042,106.56000"      # 西北角
    "29.64042,106.56016"      # 向东
    "29.64042,106.56032"      # 东北角
    "29.64028,106.56032"      # 向南
    "29.64014,106.56032"      # 向南
    "29.64000,106.56032"      # 东南角
    "29.64000,106.56016"      # 向西
    "29.64000,106.56002"      # 回到起点附近（闭环）
)

POINT_NAMES=(
    "起点（西南角）"
    "向北移动 15米"
    "继续向北 15米"
    "西北角"
    "向东移动 15米"
    "东北角"
    "向南移动 15米"
    "继续向南 15米"
    "东南角"
    "向西移动 15米"
    "回到起点（闭环）"
)

echo "🎬 现在请在 App 中点击「开始圈地」按钮"
echo "   （右下角的蓝色按钮）"
echo ""
read -p "点击后，按回车键继续..."

# 遍历每个点
for i in "${!POINTS[@]}"; do
    POINT="${POINTS[$i]}"
    NAME="${POINT_NAMES[$i]}"

    echo ""
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo "📍 点 $((i+1))/${#POINTS[@]}: $NAME"
    echo "   坐标: $POINT"

    # 设置模拟器位置
    xcrun simctl location "$SIMULATOR_ID" set "$POINT"

    if [ $? -eq 0 ]; then
        echo "   ✅ 位置已设置"
    else
        echo "   ❌ 位置设置失败"
    fi

    # 等待 3 秒（确保定时器触发）
    if [ $i -lt $((${#POINTS[@]}-1)) ]; then
        echo "   ⏳ 等待 3 秒..."
        sleep 3
    fi
done

echo ""
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "✅ 轨迹播放完成！"
echo ""
echo "📊 预期结果："
echo "   - 已记录 11 个点"
echo "   - 距离约 160 米"
echo "   - 面积约 1600 平方米"
echo "   - 应该显示绿色横幅：「圈地成功！领地面积: 1600m²」"
echo ""
echo "🔍 请检查："
echo "   1. 切换到「地图」Tab"
echo "   2. 查看是否有绿色成功横幅"
echo "   3. 地图上是否显示完整的正方形轨迹"
echo "   4. 按钮显示「停止圈地 (11)」"
echo ""
echo "📝 查看详细日志："
echo "   1. 切换到「更多」Tab"
echo "   2. 点击「圈地功能测试」"
echo "   3. 查看完整的验证过程"
echo ""
